
<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Quick Start Guide Example</title>
    <meta charset="utf-8" />

    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.css" />
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html,
        body,
        #map {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.js"></script>
    <script src="./Lib/Leaflet-0.7.NonTiledLayer.js"></script>
    <script src="./Lib/Leaflet-0.7.PostLayer.js"></script>
    <script>

        var map = L.map('map').setView([51.505, -0.09], 13);

        var attribution = '<a href="http://www.ptvgroup.com">PTV</a>, TOMTOM';

        var getRequest = function (world1, world2, width, height) {
            var request = {
                "mapSection":
                    {
                        "leftTop":
                          {
                              "point":
                                       { "x": world1.lng, "y": world1.lat }
                          }, "rightBottom":
                          {
                              "point":
                                  { "x": world2.lng, "y": world2.lat }
                          }
                    }, "mapParams": { "showScale": false, "useMiles": false },
                "layers": [],
                "imageInfo": { "format": "PNG", "width": width, "height": height },
                "includeImageInResponse": true, "callerContext": {
                    "properties": [
                         { "key": "CoordFormat", "value": "OG_GEODECIMAL" }]
                }
            };
            return request;
        };

        var getImageFromResponse = function (response) {
            var prefixMap = {
                "iVBOR": "data:image/png;base64,",
                "R0lGO": "data:image/gif;base64,",
                "/9j/4": "data:image/jpeg;base64,",
                "Qk02U": "data:image/bmp;base64,"
            };

            var rawImage = response.image.rawImage;

            return prefixMap[rawImage.substr(0, 5)] + rawImage;
        };

        var singleTileLayer = new L.PostLayer.NonTiled(
            'https://xmap-eu-n-test.cloud.ptvgroup.com/xmap/rs/XMap/renderMapBoundingBox',
            getRequest, getImageFromResponse,
            {
                authHeader: "Basic " + btoa("xtok:" + '561677741926322'),
                attribution: attribution,
                pane: map.getPanes().tilePane
            }
        ).addTo(map);

        var multiTileLayer = new L.PostLayer.Tiled(
		    'https://xmap-eu-n-test.cloud.ptvgroup.com/xmap/rs/XMap/renderMapBoundingBox',
		    getRequest, getImageFromResponse,
		    {
		        authHeader: "Basic " + btoa("xtok:" + '561677741926322'),
		        attribution: attribution
		    }
        );

        L.control.layers({
            "ViewPort-based": singleTileLayer,
            "Tile-based": multiTileLayer
        }).addTo(map);

        L.marker([51.5, -0.09]).addTo(map)
			.bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();

        L.circle([51.508, -0.11], 500, {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5
        }).addTo(map).bindPopup("I am a circle.");

        L.polygon([
			[51.509, -0.08],
			[51.503, -0.06],
			[51.51, -0.047]
        ]).addTo(map).bindPopup("I am a polygon.");


        var popup = L.popup();

        function onMapClick(e) {
            popup
				.setLatLng(e.latlng)
				.setContent("You clicked the map at " + e.latlng.toString())
				.openOn(map);
        }

        map.on('click', onMapClick);

    </script>
</body>
</html>
